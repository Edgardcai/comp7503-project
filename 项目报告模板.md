# COMP7503 智慧城市项目报告

**课程名称**: Multimedia Technologies
**项目名称**: 基于香港开放数据的智慧城市分析系统
**小组成员**: [请填写小组成员姓名和学号]
**提交日期**: 2025年11月29日

---

## 目录

1. [项目概述](#1-项目概述)
2. [智慧城市用例设计](#2-智慧城市用例设计)
3. [系统架构](#3-系统架构)
4. [实现细节](#4-实现细节)
5. [数据存储方案](#5-数据存储方案)
6. [Dashboard设计与实现](#6-dashboard设计与实现)
7. [数据分析与洞察](#7-数据分析与洞察)
8. [测试与验证](#8-测试与验证)
9. [遇到的挑战与解决方案](#9-遇到的挑战与解决方案)
10. [总结与未来展望](#10-总结与未来展望)
11. [参考文献](#11-参考文献)
12. [附录](#12-附录)

---

## 1. 项目概述

### 1.1 项目背景

智慧城市是运用信息和通信技术手段感测、分析、整合城市运行核心系统的各项关键信息，从而对包括民生、环保、公共安全、城市服务、工商业活动在内的各种需求做出智能响应。香港作为国际大都市，面临着交通拥堵、空气污染、能源消耗等城市挑战。

香港政府通过 https://data.gov.hk/ 平台开放了大量的城市运行数据，为智慧城市应用开发提供了良好的数据基础。本项目基于这些开放数据，设计并实现了一个智慧城市数据分析系统，旨在：

1. **实时监测**: 对城市关键指标进行实时数据采集和监测
2. **数据关联**: 分析不同城市数据之间的关联关系
3. **洞察发现**: 从数据中提取有价值的洞察，支持城市管理决策
4. **可视化展示**: 通过直观的仪表板展示数据和分析结果

### 1.2 项目目标

- 设计并实现3个或以上的智慧城市用例
- 使用Node-RED实现数据采集、处理和可视化流程
- 使用MongoDB存储历史数据，支持时间序列分析
- 开发交互式Dashboard，提供实时监控和历史分析功能
- 通过数据关联分析，发现城市运行规律和问题

### 1.3 技术选型

| 组件 | 技术选择 | 选择理由 |
|------|---------|---------|
| 数据采集与处理 | Node-RED | 可视化编程、易于集成API、丰富的节点库 |
| 数据存储 | MongoDB | 灵活的文档结构、适合时间序列数据、易于扩展 |
| 容器化部署 | Docker & Docker Compose | 环境一致性、易于部署和管理 |
| 可视化 | Node-RED Dashboard | 与Node-RED无缝集成、实时更新、交互性强 |

---

## 2. 智慧城市用例设计

### 2.1 用例一：空气质量与交通流量关联分析

#### 2.1.1 用例描述

**问题陈述**: 城市空气质量受多种因素影响，其中交通排放是重要来源。了解空气质量与交通流量的关系，可以为交通管理和环境保护政策提供依据。

**用例目标**:
- 实时监测香港各区空气质量指数(AQI)
- 采集主要道路的交通流量数据
- 分析空气质量与交通流量的时空关联
- 识别高污染时段和区域
- 为交通限流措施提供数据支持

**数据源**:
1. 环保署空气质量健康指数API
   - URL: `https://data.gov.hk/en-data/dataset/hk-epd-airteam-air-quality-health-index`
   - 更新频率: 每小时
   - 数据内容: AQI、PM2.5、PM10、NO2、SO2、O3等

2. 运输署交通快拍影像API
   - URL: `https://data.gov.hk/en-data/dataset/hk-td-tis_2-traffic-snapshot-images`
   - 更新频率: 每2分钟
   - 数据内容: 交通快拍图像、位置信息

3. 天文台气象数据
   - URL: `https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread`
   - 更新频率: 每小时
   - 数据内容: 温度、湿度、风速、风向、降雨量

#### 2.1.2 分析方法

1. **时间序列分析**
   - 使用移动平均法平滑AQI和交通流量数据
   - 识别日、周、月的变化趋势
   - 对比工作日与周末的差异

2. **相关性分析**
   - 计算AQI与交通流量的皮尔逊相关系数
   - 分析不同时间滞后下的相关性
   - 考虑气象因素的影响（温度、风速等）

3. **空间分析**
   - 绘制AQI热力图
   - 叠加交通流量密度图
   - 识别高污染-高流量区域

#### 2.1.3 预期洞察

- 交通高峰时段（7-9am, 5-7pm）与AQI峰值的关系
- 周末交通流量减少时AQI的改善情况
- 风速风向对污染扩散的影响
- 特定路段交通对周边空气质量的影响范围

### 2.2 用例二：天气预警与公共交通延误预测

#### 2.2.1 用例描述

**问题陈述**: 恶劣天气（如台风、暴雨）常导致公共交通延误，影响市民出行。提前预测延误可以帮助市民规划行程。

**用例目标**:
- 监测天气预报和实时天气状况
- 采集公共交通（港铁、巴士）的实时运行数据
- 建立天气与交通延误的关联模型
- 提供延误预警和出行建议

**数据源**:
1. 天文台天气预报API
2. 港铁服务状态API
3. 巴士到站时间API
4. 历史延误数据（自建数据集）

#### 2.2.2 分析方法

[请根据实际实现填写具体的分析方法]

#### 2.2.3 预期洞察

[请根据实际实现填写预期发现的洞察]

### 2.3 用例三：能源消耗与环境因素分析

#### 2.3.1 用例描述

**问题陈述**: 建筑能源消耗受环境温度、湿度等因素影响。分析这些关系可以优化能源使用，减少碳排放。

**用例目标**:
- 监测环境温度、湿度变化
- 分析能源消耗模式
- 识别能源浪费的时段和原因
- 提供节能建议

**数据源**:
[请根据实际选择的数据源填写]

#### 2.3.2 分析方法

[请根据实际实现填写具体的分析方法]

#### 2.3.3 预期洞察

[请根据实际实现填写预期发现的洞察]

---

## 3. 系统架构

### 3.1 整体架构图

```
┌──────────────────────────────────────────────────────────────┐
│                    Hong Kong Open Data Platform              │
│                      (data.gov.hk)                           │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         │ HTTPS / REST API
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                      Node-RED Layer                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │   Inject   │─▶│HTTP Request│─▶│  Function  │            │
│  │   Timer    │  │   Nodes    │  │   Nodes    │            │
│  └────────────┘  └────────────┘  └─────┬──────┘            │
│                                         │                     │
│                                         ▼                     │
│                                  ┌─────────────┐             │
│                                  │  MongoDB    │             │
│                                  │   Output    │             │
│                                  └─────┬───────┘             │
│                                        │                      │
│                                        ▼                      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Dashboard UI Nodes                      │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │   │
│  │  │ Chart  │ │ Gauge  │ │ Table  │ │  Text  │       │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘       │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    MongoDB Database                          │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │air_quality    │  │traffic_flow   │  │weather_data   │   │
│  │collection     │  │collection     │  │collection     │   │
│  └───────────────┘  └───────────────┘  └───────────────┘   │
└──────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    User Dashboard                            │
│                   (Web Browser)                              │
│                http://localhost:1880/ui                      │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 数据流设计

#### 3.2.1 数据采集层

**设计原则**:
- 定时触发，避免API限流
- 错误重试机制
- 数据验证和清洗

**实现细节**:
```
Inject Node (定时器)
    ↓
HTTP Request Node (API调用)
    ↓
Function Node (数据解析和验证)
    ↓
[分支1] MongoDB Output (原始数据存储)
[分支2] 数据处理层
```

#### 3.2.2 数据处理层

**功能**:
- 数据清洗：去除异常值、处理缺失值
- 数据转换：格式标准化、单位转换
- 数据聚合：计算统计量、趋势分析
- 数据关联：多数据源的时间戳对齐

#### 3.2.3 数据存储层

**MongoDB集合设计**:
- `air_quality`: 空气质量原始数据
- `traffic_flow`: 交通流量数据
- `weather_data`: 天气数据
- `analysis_results`: 分析结果
- `alerts`: 告警记录

#### 3.2.4 可视化层

**Dashboard页面结构**:
- **实时监控页**: 当前状态、最新数据
- **历史分析页**: 时间范围选择、趋势图表
- **关联分析页**: 多维度数据对比
- **告警页**: 告警历史、规则配置

### 3.3 技术栈详细说明

#### 3.3.1 Node-RED

**版本**: 3.1.0

**核心节点**:
- `inject`: 定时触发数据采集
- `http request`: API调用
- `function`: JavaScript数据处理
- `mongodb`: 数据库操作
- `dashboard`: UI组件

**扩展节点**:
- `node-red-dashboard`: Dashboard UI
- `node-red-node-mongodb`: MongoDB集成
- `node-red-contrib-aggregator`: 数据聚合
- `node-red-contrib-moment`: 时间处理

#### 3.3.2 MongoDB

**版本**: Latest (建议5.0+)

**特性使用**:
- 文档存储：灵活的数据结构
- 索引：时间戳、地理位置索引
- 聚合管道：复杂查询和统计
- TTL索引：自动清理过期数据

#### 3.3.3 Docker

**容器配置**:
- `node-red`: Node-RED服务，端口1880
- `mongodb`: MongoDB服务，端口27017
- `mongo-express`: 数据库管理UI，端口8081

---

## 4. 实现细节

### 4.1 环境搭建

#### 4.1.1 Docker环境配置

**docker-compose.yml 说明**:

```yaml
version: '3.8'

services:
  node-red:
    image: nodered/node-red:latest
    ports:
      - "1880:1880"
    volumes:
      - node-red-data:/data
    depends_on:
      - mongodb

  mongodb:
    image: mongo:latest
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
```

**启动步骤**:
```bash
# 1. 启动所有服务
docker-compose up -d

# 2. 查看服务状态
docker-compose ps

# 3. 查看日志
docker-compose logs -f node-red
```

#### 4.1.2 Node-RED初始配置

1. 访问 http://localhost:1880
2. 安装必要的节点包
3. 配置MongoDB连接
4. 导入flow文件

### 4.2 Node-RED Flow实现

#### 4.2.1 Flow 1: 空气质量数据采集

**节点配置**:

1. **Inject节点**
   - Name: "每15分钟触发"
   - Repeat interval: 900秒
   - Once after: 1秒（首次立即执行）

2. **HTTP Request节点**
   - Name: "获取空气质量数据"
   - Method: GET
   - URL: `https://data.gov.hk/en-data/dataset/...` [实际API地址]
   - Return: Parsed JSON object

3. **Function节点 - 数据解析**
   - Name: "解析空气质量数据"
   - 功能:
     * 提取关键字段
     * 数据验证
     * 格式转换
     * 添加时间戳

   代码示例:
   ```javascript
   var data = msg.payload;
   var timestamp = new Date();

   var records = data.map(function(item) {
       return {
           station: item.station,
           aqi: parseInt(item.aqi),
           health_risk: item.health_risk,
           pollutants: {
               pm25: parseFloat(item.pm25),
               pm10: parseFloat(item.pm10),
               // ...
           },
           timestamp: timestamp,
           raw_data: item
       };
   });

   msg.payload = records;
   msg.collection = "air_quality";
   return msg;
   ```

4. **MongoDB Output节点**
   - Name: "存储到MongoDB"
   - Server: mongodb_config
   - Collection: msg.collection
   - Operation: insert

5. **Debug节点**
   - 用于开发调试，生产环境可禁用

**数据流图**:
```
[每15分钟触发] → [HTTP请求] → [数据解析] → [MongoDB存储]
                                    ↓
                                [Debug输出]
                                    ↓
                              [Dashboard显示]
```

#### 4.2.2 Flow 2: 天气数据采集

[请根据实际实现填写详细配置]

#### 4.2.3 Flow 3: 交通数据采集

[请根据实际实现填写详细配置]

#### 4.2.4 Flow 4: 数据关联分析

**功能**: 每小时运行一次，分析空气质量与交通流量的关系

**实现步骤**:

1. **查询最近1小时数据**
   ```javascript
   var oneHourAgo = new Date(Date.now() - 3600000);
   msg.payload = {
       timestamp: { $gte: oneHourAgo }
   };
   return msg;
   ```

2. **计算相关系数**
   [详细算法说明]

3. **识别异常模式**
   [异常检测逻辑]

4. **存储分析结果**
   [结果数据结构]

### 4.3 错误处理和容错机制

#### 4.3.1 API调用失败处理

```javascript
// Function节点中的错误处理示例
try {
    var data = msg.payload;

    if (!data || typeof data !== 'object') {
        throw new Error('Invalid API response');
    }

    // 数据处理逻辑
    // ...

} catch (error) {
    node.error('数据处理失败: ' + error.message, msg);

    // 可以选择：
    // 1. 跳过此次处理
    // 2. 使用默认值
    // 3. 触发告警

    return null; // 终止流程
}
```

#### 4.3.2 数据库连接失败

- 使用连接池
- 自动重连机制
- 降级处理（缓存到文件）

#### 4.3.3 数据质量保证

- 数据范围验证
- 缺失值处理策略
- 异常值检测和标记

---

## 5. 数据存储方案

### 5.1 MongoDB数据模型设计

#### 5.1.1 Collection: air_quality

**用途**: 存储空气质量监测数据

**数据结构**:
```json
{
    "_id": ObjectId("..."),
    "station": "中西区",
    "aqi": 45,
    "health_risk": "低",
    "pollutants": {
        "pm25": 18.5,
        "pm10": 35.2,
        "no2": 42.8,
        "so2": 8.3,
        "o3": 25.6
    },
    "location": {
        "type": "Point",
        "coordinates": [114.1577, 22.2855]
    },
    "timestamp": ISODate("2025-01-15T08:00:00Z"),
    "raw_data": { ... }
}
```

**索引设计**:
```javascript
// 时间索引（支持时间范围查询）
db.air_quality.createIndex({ "timestamp": -1 });

// 复合索引（支持按站点查询历史数据）
db.air_quality.createIndex({ "station": 1, "timestamp": -1 });

// 地理位置索引（支持空间查询）
db.air_quality.createIndex({ "location": "2dsphere" });

// TTL索引（自动清理3个月前的数据）
db.air_quality.createIndex(
    { "timestamp": 1 },
    { expireAfterSeconds: 7776000 }  // 90天
);
```

#### 5.1.2 Collection: traffic_flow

**用途**: 存储交通流量数据

**数据结构**:
```json
{
    "_id": ObjectId("..."),
    "location": "中环干诺道",
    "traffic_density": "缓慢",
    "vehicle_count": 85,
    "average_speed": 35,
    "camera_id": "CAM_001",
    "coordinates": {
        "type": "Point",
        "coordinates": [114.1577, 22.2819]
    },
    "timestamp": ISODate("2025-01-15T08:00:00Z"),
    "raw_data": { ... }
}
```

**索引设计**:
```javascript
db.traffic_flow.createIndex({ "timestamp": -1 });
db.traffic_flow.createIndex({ "location": 1, "timestamp": -1 });
db.traffic_flow.createIndex({ "coordinates": "2dsphere" });
```

#### 5.1.3 Collection: weather_data

**用途**: 存储天气数据

**数据结构**:
```json
{
    "_id": ObjectId("..."),
    "location": "香港天文台",
    "temperature": 18.5,
    "humidity": 75,
    "rainfall": 0,
    "wind_speed": 15,
    "wind_direction": "东北",
    "pressure": 1013.2,
    "timestamp": ISODate("2025-01-15T08:00:00Z"),
    "forecast": {
        "next_6h": { ... },
        "next_24h": { ... }
    }
}
```

#### 5.1.4 Collection: analysis_results

**用途**: 存储分析结果

**数据结构**:
```json
{
    "_id": ObjectId("..."),
    "analysis_type": "aqi_traffic_correlation",
    "time_range": {
        "start": ISODate("2025-01-15T00:00:00Z"),
        "end": ISODate("2025-01-15T23:59:59Z")
    },
    "results": {
        "correlation_coefficient": 0.72,
        "patterns": [
            {
                "description": "工作日早高峰AQI明显升高",
                "confidence": 0.85
            }
        ],
        "anomalies": [
            {
                "timestamp": ISODate("..."),
                "description": "AQI异常峰值",
                "value": 125
            }
        ],
        "insights": "交通流量与AQI呈强正相关..."
    },
    "timestamp": ISODate("2025-01-15T23:59:59Z")
}
```

### 5.2 数据保留策略

| 数据类型 | 原始数据保留期 | 聚合数据保留期 |
|---------|---------------|---------------|
| 空气质量 | 3个月 | 永久（按天聚合） |
| 交通流量 | 1个月 | 永久（按小时聚合） |
| 天气数据 | 6个月 | 永久（按天聚合） |
| 分析结果 | 永久 | N/A |

**实现方法**:
1. 使用MongoDB TTL索引自动删除过期原始数据
2. 定时任务（每天凌晨）进行数据聚合
3. 聚合数据存储在单独的collection中

### 5.3 数据聚合示例

#### 5.3.1 按小时聚合AQI数据

```javascript
db.air_quality.aggregate([
    {
        $match: {
            timestamp: {
                $gte: ISODate("2025-01-15T00:00:00Z"),
                $lt: ISODate("2025-01-16T00:00:00Z")
            }
        }
    },
    {
        $group: {
            _id: {
                station: "$station",
                hour: { $hour: "$timestamp" }
            },
            avg_aqi: { $avg: "$aqi" },
            max_aqi: { $max: "$aqi" },
            min_aqi: { $min: "$aqi" },
            avg_pm25: { $avg: "$pollutants.pm25" },
            count: { $sum: 1 }
        }
    },
    {
        $sort: { "_id.hour": 1 }
    },
    {
        $out: "air_quality_hourly"
    }
]);
```

---

## 6. Dashboard设计与实现

### 6.1 Dashboard整体布局

**页面结构**:

```
┌─────────────────────────────────────────────────────────┐
│                    导航栏                                │
│    [实时监控] [历史分析] [关联分析] [系统状态]          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│                    页面内容区                            │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 6.2 页面一：实时监控

#### 6.2.1 布局设计

```
┌────────────┬────────────┬────────────┐
│  平均AQI   │  最高温度  │  交通状况  │
│   Gauge    │   Gauge    │   Gauge    │
├────────────┴────────────┴────────────┤
│         各区AQI柱状图                 │
│                                       │
├───────────────────────────────────────┤
│         温度趋势图（最近24小时）       │
│                                       │
├───────────────────────────────────────┤
│  交通状况饼图  │  最新数据表格       │
│                │                      │
└────────────────┴──────────────────────┘
```

#### 6.2.2 组件配置

**1. 平均AQI Gauge**
- 类型: `ui_gauge`
- 数据源: 实时计算的平均AQI
- 范围: 0-150
- 颜色区间:
  - 0-50: 绿色（良好）
  - 50-100: 黄色（中等）
  - 100-150: 红色（不健康）
- 更新频率: 每15分钟

**2. 各区AQI柱状图**
- 类型: `ui_chart`
- 图表类型: Bar Chart
- X轴: 监测站名称
- Y轴: AQI值
- 颜色: 根据AQI值自动着色
- 数据点: 最新一次采集的所有站点数据

**3. 温度趋势图**
- 类型: `ui_chart`
- 图表类型: Line Chart
- X轴: 时间（最近24小时）
- Y轴: 温度（℃）
- 多系列: 每个监测站一条线
- 图例: 显示
- 数据点: 从MongoDB查询最近24小时数据

**4. 交通状况饼图**
- 类型: `ui_chart`
- 图表类型: Pie Chart
- 分类: 畅通、缓慢、拥堵
- 数据: 当前各状态的路段数量
- 颜色: 绿、黄、红

**5. 最新数据表格**
- 类型: `ui_table`
- 列: 时间、类型、位置、数值
- 行数: 最新10条记录
- 排序: 按时间倒序

### 6.3 页面二：历史分析

#### 6.3.1 功能设计

- 时间范围选择器（日期范围选择）
- 指标选择（AQI、温度、交通流量等）
- 对比模式（日对比、周对比、月对比）
- 导出功能（CSV格式）

#### 6.3.2 关键组件

**时间范围选择器**:
```javascript
// Function节点代码
var startDate = new Date(msg.payload.startDate);
var endDate = new Date(msg.payload.endDate);

// 查询MongoDB
msg.payload = {
    timestamp: {
        $gte: startDate,
        $lte: endDate
    }
};
msg.collection = "air_quality";

return msg;
```

**趋势分析图表**:
- 支持多指标叠加显示
- 缩放和平移功能
- 数据点hover显示详细信息

### 6.4 页面三：关联分析

#### 6.4.1 功能设计

- AQI vs 交通流量散点图
- 温度 vs 能源消耗关联图
- 相关系数计算和显示
- 回归分析曲线

#### 6.4.2 散点图实现

**数据准备**:
```javascript
// 从MongoDB查询同一时间段的两组数据
var aqiData = []; // 从air_quality查询
var trafficData = []; // 从traffic_flow查询

// 按时间戳对齐数据
var scatterData = [];
for (var i = 0; i < aqiData.length; i++) {
    var matchingTraffic = trafficData.find(t =>
        Math.abs(t.timestamp - aqiData[i].timestamp) < 300000 // 5分钟内
    );

    if (matchingTraffic) {
        scatterData.push({
            x: matchingTraffic.vehicle_count,
            y: aqiData[i].aqi,
            timestamp: aqiData[i].timestamp
        });
    }
}

msg.payload = scatterData;
return msg;
```

### 6.5 页面四：系统状态

#### 6.5.1 监控指标

- 数据采集状态（各API的最后采集时间）
- 数据库存储量（各collection的文档数）
- 系统运行时间
- 错误日志（最近的错误记录）

#### 6.5.2 实现方式

使用Node-RED的`status`节点监控flow状态，将系统信息展示在Dashboard上。

---

## 7. 数据分析与洞察

### 7.1 空气质量与交通流量关联分析

#### 7.1.1 分析方法

**相关性分析**:

使用皮尔逊相关系数衡量AQI与交通流量的线性关系：

$$r = \frac{\sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^{n}(x_i - \bar{x})^2 \sum_{i=1}^{n}(y_i - \bar{y})^2}}$$

其中：
- $x_i$: 第i个时间点的交通流量
- $y_i$: 第i个时间点的AQI
- $\bar{x}$, $\bar{y}$: 各自的平均值

**实现代码**:
```javascript
function calculateCorrelation(x, y) {
    var n = x.length;
    var sum_x = 0, sum_y = 0, sum_xy = 0;
    var sum_x2 = 0, sum_y2 = 0;

    for (var i = 0; i < n; i++) {
        sum_x += x[i];
        sum_y += y[i];
        sum_xy += x[i] * y[i];
        sum_x2 += x[i] * x[i];
        sum_y2 += y[i] * y[i];
    }

    var numerator = n * sum_xy - sum_x * sum_y;
    var denominator = Math.sqrt((n * sum_x2 - sum_x * sum_x) *
                                (n * sum_y2 - sum_y * sum_y));

    return numerator / denominator;
}
```

#### 7.1.2 发现的洞察

**[请根据实际数据分析结果填写]**

示例:
1. **早高峰时段（7-9am）相关性最强**
   - 相关系数: r = 0.78
   - 解释: 通勤交通导致污染物排放增加

2. **周末相关性减弱**
   - 周末相关系数: r = 0.45
   - 工作日相关系数: r = 0.75
   - 解释: 周末交通流量减少，其他污染源影响增大

3. **风速的调节作用**
   - 高风速时（>20 km/h），相关性降至0.4
   - 低风速时（<10 km/h），相关性升至0.85
   - 解释: 风速影响污染物扩散

### 7.2 时间序列趋势分析

#### 7.2.1 分析方法

**移动平均法**:

使用7日移动平均平滑每日AQI数据，识别长期趋势。

$$MA_t = \frac{1}{7} \sum_{i=0}^{6} AQI_{t-i}$$

**实现代码**:
```javascript
function movingAverage(data, windowSize) {
    var result = [];
    for (var i = windowSize - 1; i < data.length; i++) {
        var sum = 0;
        for (var j = 0; j < windowSize; j++) {
            sum += data[i - j];
        }
        result.push(sum / windowSize);
    }
    return result;
}
```

#### 7.2.2 发现的趋势

**[请根据实际数据填写]**

### 7.3 异常检测

#### 7.3.1 检测方法

使用Z-score方法检测异常值：

$$Z = \frac{x - \mu}{\sigma}$$

当 $|Z| > 3$ 时，认为是异常值。

#### 7.3.2 检测到的异常

**[请根据实际数据填写]**

---

## 8. 测试与验证

### 8.1 功能测试

#### 8.1.1 数据采集测试

**测试用例1: API调用成功**
- 测试步骤: 手动触发inject节点
- 预期结果: HTTP Request节点返回200状态码，payload包含有效数据
- 实际结果: [填写]
- 状态: [通过/失败]

**测试用例2: API调用失败处理**
- 测试步骤: 断开网络连接，触发inject节点
- 预期结果: Debug节点显示错误信息，flow不崩溃
- 实际结果: [填写]
- 状态: [通过/失败]

#### 8.1.2 数据存储测试

**测试用例3: MongoDB插入成功**
- 测试步骤: 采集数据后，在mongo-express中查看collection
- 预期结果: 新文档成功插入，字段完整
- 实际结果: [填写]
- 状态: [通过/失败]

#### 8.1.3 Dashboard测试

**测试用例4: 图表实时更新**
- 测试步骤: 打开Dashboard，观察15分钟后图表变化
- 预期结果: 图表自动更新，显示新数据
- 实际结果: [填写]
- 状态: [通过/失败]

### 8.2 性能测试

#### 8.2.1 数据库查询性能

**测试场景**: 查询最近24小时的空气质量数据（约96条记录）

- 无索引查询时间: [填写] ms
- 有索引查询时间: [填写] ms
- 优化效果: [填写]%

#### 8.2.2 Dashboard响应时间

**测试场景**: 打开实时监控页面

- 首次加载时间: [填写] ms
- 数据更新延迟: [填写] ms

### 8.3 数据准确性验证

#### 8.3.1 API数据验证

对比从API获取的数据与官方网站显示的数据，验证准确性。

**验证结果**:
- 空气质量数据准确率: [填写]%
- 天气数据准确率: [填写]%

#### 8.3.2 计算结果验证

使用独立工具（如Python）验证Node-RED中的统计计算结果。

**验证结果**:
- 相关系数计算误差: [填写]
- 移动平均计算误差: [填写]

---

## 9. 遇到的挑战与解决方案

### 9.1 挑战一：API数据格式不统一

**问题描述**:
不同的data.gov.hk API返回的数据格式差异较大，有的是JSON，有的是CSV，有的是XML。

**解决方案**:
1. 为每种数据源创建专门的解析Function节点
2. 统一转换为标准JSON格式后再存储
3. 在MongoDB中保留原始数据（raw_data字段），便于后续调整

**代码示例**:
```javascript
// CSV解析示例
function parseCSV(csvString) {
    var lines = csvString.split('\n');
    var headers = lines[0].split(',');
    var result = [];

    for (var i = 1; i < lines.length; i++) {
        var obj = {};
        var currentLine = lines[i].split(',');

        for (var j = 0; j < headers.length; j++) {
            obj[headers[j].trim()] = currentLine[j];
        }
        result.push(obj);
    }

    return result;
}
```

### 9.2 挑战二：数据时间戳对齐问题

**问题描述**:
不同数据源的更新频率和时间不同步，导致关联分析时无法精确匹配。

**解决方案**:
1. 时间窗口匹配：允许±5分钟的时间差
2. 插值法：对缺失时间点的数据进行线性插值
3. 统一时间粒度：将所有数据聚合到小时级别

**实现**:
```javascript
function alignTimestamps(data1, data2, toleranceMs) {
    var aligned = [];

    data1.forEach(function(item1) {
        var match = data2.find(function(item2) {
            return Math.abs(item2.timestamp - item1.timestamp) < toleranceMs;
        });

        if (match) {
            aligned.push({
                timestamp: item1.timestamp,
                value1: item1.value,
                value2: match.value
            });
        }
    });

    return aligned;
}
```

### 9.3 挑战三：大数据量下的Dashboard性能

**问题描述**:
当加载几千个数据点时，Dashboard图表渲染缓慢，甚至浏览器卡顿。

**解决方案**:
1. 数据降采样：对历史数据按时间聚合，减少数据点
2. 分页加载：历史数据分批加载
3. 使用removeOlder参数：自动清理旧数据
4. 客户端缓存：避免重复查询

**配置示例**:
```javascript
// Chart节点配置
{
    "removeOlder": 24,  // 只保留24小时数据
    "removeOlderUnit": "3600",  // 单位：秒
    "removeOlderPoints": 100  // 或只保留最新100个点
}
```

### 9.4 挑战四：API限流问题

**问题描述**:
频繁调用某些API导致被限流，返回429错误。

**解决方案**:
1. 降低采集频率：从每分钟改为每15分钟
2. 实现指数退避重试机制
3. 使用缓存：相同时间窗口内复用数据
4. 错峰采集：不同数据源错开采集时间

**重试机制实现**:
```javascript
var maxRetries = 3;
var retryCount = msg.retryCount || 0;

if (msg.statusCode === 429) {
    if (retryCount < maxRetries) {
        var delay = Math.pow(2, retryCount) * 1000; // 指数退避

        setTimeout(function() {
            msg.retryCount = retryCount + 1;
            node.send(msg); // 重新发送
        }, delay);

        return null; // 暂时不继续
    } else {
        node.error("API限流，已达最大重试次数");
        return null;
    }
}

// 请求成功，重置重试计数
delete msg.retryCount;
return msg;
```

### 9.5 挑战五：MongoDB连接不稳定

**问题描述**:
在Docker环境中，偶尔出现Node-RED无法连接MongoDB的情况。

**解决方案**:
1. 使用`depends_on`确保MongoDB先启动
2. 添加健康检查
3. 在Node-RED中配置连接重试
4. 使用持久化数据卷避免数据丢失

**Docker Compose配置**:
```yaml
mongodb:
  healthcheck:
    test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
    interval: 10s
    timeout: 5s
    retries: 5

node-red:
  depends_on:
    mongodb:
      condition: service_healthy
```

---

## 10. 总结与未来展望

### 10.1 项目总结

#### 10.1.1 完成情况

本项目成功实现了以下目标：

✅ **智慧城市用例**:
- 空气质量与交通流量关联分析
- 天气预警与公共交通延误预测
- 能源消耗与环境因素分析

✅ **技术实现**:
- 基于Docker的容器化部署
- Node-RED数据采集和处理流程
- MongoDB时间序列数据存储
- 实时Dashboard可视化

✅ **数据分析**:
- 相关性分析
- 时间序列趋势分析
- 异常检测

✅ **系统功能**:
- 自动化数据采集（24/7运行）
- 实时监控Dashboard
- 历史数据查询和分析
- 数据关联分析

#### 10.1.2 关键成果

**数据积累**:
- 累计采集 [X] 天的数据
- 空气质量记录 [X] 条
- 交通流量记录 [X] 条
- 天气数据记录 [X] 条

**发现的洞察**:
[总结3-5个关键发现]

**技术积累**:
- 掌握了Node-RED的流程编程
- 学习了MongoDB的时间序列数据处理
- 实践了Docker容器化部署
- 理解了智慧城市数据分析方法

#### 10.1.3 项目亮点

1. **完整的数据流水线**: 从采集、存储、处理到可视化的完整链路
2. **实时性**: 准实时数据更新，15分钟延迟
3. **可扩展性**: 模块化设计，易于添加新数据源
4. **容错性**: 完善的错误处理和重试机制
5. **可视化**: 直观的Dashboard展示，支持多种图表类型

### 10.2 不足与改进方向

#### 10.2.1 当前不足

1. **数据来源有限**: 主要依赖公开API，部分数据是模拟的
2. **预测功能缺失**: 目前只有描述性分析，缺少预测模型
3. **用户交互**: Dashboard交互性有限，不支持自定义查询
4. **告警功能**: 缺少主动告警通知（邮件、短信）
5. **性能优化**: 大数据量下的查询和渲染性能仍需提升

#### 10.2.2 改进建议

1. **集成更多数据源**:
   - 社交媒体数据（Twitter、微博）分析公众情绪
   - 卫星遥感数据补充空气质量监测
   - 移动运营商数据分析人流分布

2. **增强分析能力**:
   - 引入机器学习模型（TensorFlow.js）
   - 实现AQI预测（LSTM时间序列预测）
   - 开发交通流量预测模型

3. **改进用户体验**:
   - 支持自定义时间范围查询
   - 添加数据导出功能（Excel、PDF报告）
   - 多语言支持（中文、英文）
   - 移动端适配

4. **系统增强**:
   - 用户认证和权限管理
   - 数据备份和恢复机制
   - 日志系统和监控告警
   - API接口供第三方调用

### 10.3 未来展望

#### 10.3.1 短期计划（1-3个月）

1. **完善现有功能**:
   - 替换模拟数据为真实API数据
   - 优化Dashboard响应速度
   - 添加更多数据验证规则

2. **扩展数据分析**:
   - 实现周报、月报自动生成
   - 添加同比、环比分析
   - 开发异常事件自动识别

3. **改进部署**:
   - 添加HTTPS支持
   - 配置域名访问
   - 实现自动化部署（CI/CD）

#### 10.3.2 长期愿景（6-12个月）

1. **智能预测系统**:
   - 基于历史数据训练深度学习模型
   - 预测未来24小时/7天的空气质量
   - 提供出行建议和健康提示

2. **多城市对比**:
   - 扩展到其他城市（深圳、广州、澳门）
   - 建立城市间的对比分析
   - 识别最佳实践和改进机会

3. **决策支持系统**:
   - 为政府部门提供政策评估工具
   - 模拟不同政策的影响（What-if分析）
   - 优化建议生成

4. **社会影响**:
   - 向公众开放部分数据和分析结果
   - 提高市民的环保意识
   - 促进智慧城市建设

### 10.4 个人收获

**技术能力提升**:
- [填写个人技术收获]

**团队协作**:
- [填写团队协作经验]

**问题解决能力**:
- [填写遇到的困难和如何克服]

**对智慧城市的理解**:
- [填写对智慧城市的新认识]

---

## 11. 参考文献

[1] Node-RED Documentation. https://nodered.org/docs/

[2] MongoDB Manual. https://www.mongodb.com/docs/

[3] Docker Documentation. https://docs.docker.com/

[4] Hong Kong Open Data Portal. https://data.gov.hk/

[5] 香港环境保护署. 空气质量健康指数. https://www.aqhi.gov.hk/

[6] 香港天文台. 天气资料服务. https://www.hko.gov.hk/

[7] 智慧城市相关论文：
    - [请添加相关学术论文]

[8] 数据分析方法：
    - [请添加相关统计学、机器学习参考资料]

---

## 12. 附录

### 12.1 附录A：完整的Node-RED Flow JSON

[参见 SmartCity.Flow.json 文件]

### 12.2 附录B：MongoDB查询示例

#### B.1 查询最近24小时的平均AQI

```javascript
db.air_quality.aggregate([
    {
        $match: {
            timestamp: {
                $gte: new Date(Date.now() - 24*3600000)
            }
        }
    },
    {
        $group: {
            _id: null,
            avg_aqi: { $avg: "$aqi" },
            max_aqi: { $max: "$aqi" },
            min_aqi: { $min: "$aqi" }
        }
    }
]);
```

#### B.2 查询各站点的AQI排名

```javascript
db.air_quality.aggregate([
    {
        $sort: { timestamp: -1 }
    },
    {
        $group: {
            _id: "$station",
            latest_aqi: { $first: "$aqi" },
            latest_time: { $first: "$timestamp" }
        }
    },
    {
        $sort: { latest_aqi: -1 }
    }
]);
```

### 12.3 附录C：常用数据分析函数

#### C.1 计算标准差

```javascript
function calculateStdDev(values) {
    var avg = values.reduce((a, b) => a + b, 0) / values.length;
    var variance = values.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / values.length;
    return Math.sqrt(variance);
}
```

#### C.2 线性回归

```javascript
function linearRegression(x, y) {
    var n = x.length;
    var sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0;

    for (var i = 0; i < n; i++) {
        sum_x += x[i];
        sum_y += y[i];
        sum_xy += x[i] * y[i];
        sum_x2 += x[i] * x[i];
    }

    var slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x * sum_x);
    var intercept = (sum_y - slope * sum_x) / n;

    return { slope: slope, intercept: intercept };
}
```

### 12.4 附录D：系统运行日志示例

```
[2025-01-15 08:00:00] INFO: 空气质量数据采集成功，记录数：5
[2025-01-15 08:00:01] INFO: 数据已存储到MongoDB
[2025-01-15 08:00:02] INFO: Dashboard已更新
[2025-01-15 08:15:00] INFO: 空气质量数据采集成功，记录数：5
[2025-01-15 08:30:00] INFO: 天气数据采集成功
[2025-01-15 08:30:15] WARN: 检测到AQI异常值：125（中西区）
[2025-01-15 09:00:00] INFO: 每小时关联分析完成，相关系数：0.72
```

### 12.5 附录E：部署清单

**提交文件**:
- [x] SmartCity.Flow.json - Node-RED流程文件
- [x] docker-compose.yml - Docker配置
- [x] Dockerfile - 自定义镜像（可选）
- [x] package.json - Node依赖声明
- [x] 项目报告.pdf - 本报告的PDF版本
- [x] README.md - 快速入门指南

**Docker镜像信息**:
- Docker Hub ID: [填写你的Docker Hub用户名]
- 镜像名称: [填写]
- 镜像标签: [填写]

**运行环境要求**:
- Docker版本: 20.10+
- Docker Compose版本: 2.0+
- 内存: 至少4GB
- 磁盘空间: 至少10GB

---

## 项目声明

本项目是COMP7503课程的编程作业，所有代码和分析均由小组成员独立完成。我们保证：

1. 没有抄袭他人代码或报告
2. 所有引用的资料已在参考文献中标注
3. 团队成员分工明确，贡献均衡
4. 数据来源真实可靠

**小组成员及分工**:
- 成员1 [姓名学号]: [负责的工作]
- 成员2 [姓名学号]: [负责的工作]
- 成员3 [姓名学号]: [负责的工作]

**日期**: 2025年11月29日

---

**报告结束**
