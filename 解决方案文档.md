# COMP7503 智慧城市项目 - 详细解决方案

## 项目概述

本项目基于香港政府开放数据平台（https://data.gov.hk/），实现多个智慧城市用例，包括数据采集、分析、关联和可视化展示。

### 截止日期
2025年11月29日 23:55前

### 技术栈
- **Node-RED**: 流程编排和数据处理
- **MongoDB**: 数据存储
- **Docker**: 容器化部署
- **Dashboard**: 数据可视化

## 智慧城市用例设计

### 用例1: 空气质量与交通流量关联分析
**目标**: 分析空气质量指数(AQI)与交通流量的关系，为城市交通管理提供决策支持。

**数据源**:
1. 环保署空气质量健康指数 API
2. 运输署交通快拍影像 API
3. 天文台气象数据 API

**分析维度**:
- 时间维度: 按小时/日/周分析
- 空间维度: 不同监测站点的数据对比
- 关联分析: 交通流量与空气质量的相关性

### 用例2: 天气预警与公共交通延误预测
**目标**: 结合天气数据预测公共交通可能出现的延误。

**数据源**:
1. 天文台天气预报 API
2. 港铁/巴士实时到站数据
3. 历史天气与交通延误数据

**分析维度**:
- 恶劣天气对公共交通的影响
- 延误模式识别
- 预警系统

### 用例3: 能源消耗与环境因素分析
**目标**: 分析温度、湿度等环境因素对能源消耗的影响。

**数据源**:
1. 天文台气象数据
2. 政府建筑能源消耗数据
3. 温度、湿度、降雨量等环境数据

## 技术架构

### 系统架构图
```
┌─────────────────┐
│  data.gov.hk    │
│   Open Data     │
└────────┬────────┘
         │
         │ HTTP API
         ▼
┌─────────────────┐
│    Node-RED     │
│  ┌───────────┐  │
│  │  Inject   │  │  定时触发
│  └─────┬─────┘  │
│        │        │
│  ┌─────▼─────┐  │
│  │HTTP Request│  │  数据获取
│  └─────┬─────┘  │
│        │        │
│  ┌─────▼─────┐  │
│  │ Function  │  │  数据处理
│  └─────┬─────┘  │
│        │        │
│  ┌─────▼─────┐  │
│  │ MongoDB   │  │  数据存储
│  └─────┬─────┘  │
│        │        │
│  ┌─────▼─────┐  │
│  │Dashboard  │  │  数据展示
│  └───────────┘  │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│    MongoDB      │
│   Database      │
└─────────────────┘
```

### 数据流设计

#### 1. 数据采集层
- 使用 `inject` 节点定时触发（建议每5-15分钟一次）
- 使用 `http request` 节点调用 data.gov.hk API
- 使用 `function` 节点处理API响应

#### 2. 数据处理层
- 数据清洗: 去除异常值、缺失值处理
- 数据转换: 格式标准化、单位转换
- 数据关联: 多数据源的时间戳对齐
- 数据聚合: 统计计算、趋势分析

#### 3. 数据存储层
- 原始数据存储: 保留完整的API响应
- 处理后数据: 清洗和转换后的结构化数据
- 聚合数据: 预计算的统计数据

#### 4. 可视化层
- 实时监控仪表板
- 历史趋势图表
- 关联分析图表
- 预警通知

## 实现细节

### 第一步: 环境搭建

#### Docker 容器配置

**前置步骤：创建自定义网络**
```bash
# 创建用于容器间通信的网络
docker network create my-app-network
```

**启动 MongoDB 容器**
```bash
docker run -d --name mymongo --network my-app-network \
-p 27017:27017 -v /Users/zijiancai/Desktop/hkucsfiles/comp7503/hw/mongo:/data/db \
-e MONGO_INITDB_ROOT_USERNAME=admin \
-e MONGO_INITDB_ROOT_PASSWORD=1234 \
mongo:latest --auth
```

**启动 Node-RED 容器**
```bash
docker run -d --name nodered --network my-app-network \
-p 1880:1880 -v /Users/zijiancai/Desktop/hkucsfiles/comp7503/hw/nodered:/data \
nodered/node-red:latest
```

**检查容器状态**
```bash
docker ps
```

访问 Node-RED: http://localhost:1880

### 第二步: Node-RED Flow 开发

#### Flow 1: 空气质量数据采集
1. **Inject 节点**: 每15分钟触发一次
2. **HTTP Request 节点**:
   - URL: https://data.gov.hk/en-data/dataset/hk-epd-aqi/resource/[resource-id]
   - Method: GET
   - Return: Parsed JSON object
3. **Function 节点 - 数据解析**:
   ```javascript
   // 提取关键数据
   var data = msg.payload;
   var timestamp = new Date();

   var records = data.map(function(item) {
       return {
           station: item.station,
           aqi: item.aqi,
           health_risk: item.health_risk,
           timestamp: timestamp,
           raw_data: item
       };
   });

   msg.payload = records;
   return msg;
   ```
4. **MongoDB 节点**: 存储到 `air_quality` 集合
5. **Debug 节点**: 调试输出

#### Flow 2: 交通数据采集
类似的流程，调用交通快拍API

#### Flow 3: 数据关联分析
1. **Inject 节点**: 每小时触发
2. **MongoDB 节点**: 查询最近1小时的空气质量数据
3. **MongoDB 节点**: 查询最近1小时的交通数据
4. **Function 节点 - 关联计算**:
   ```javascript
   // 计算相关性
   var airQuality = msg.payload.airQuality;
   var traffic = msg.payload.traffic;

   // 按时间对齐数据
   // 计算相关系数
   // 识别异常模式

   msg.payload = {
       correlation: correlationResult,
       insights: insights,
       timestamp: new Date()
   };
   return msg;
   ```
5. **MongoDB 节点**: 存储分析结果
6. **Dashboard 节点**: 可视化展示

#### Flow 4: Dashboard 展示
使用 node-red-dashboard 节点:
- **Chart 节点**: 显示时间序列图
- **Gauge 节点**: 显示当前AQI指数
- **Table 节点**: 显示数据列表
- **Text 节点**: 显示分析结果

### 第三步: MongoDB 数据模型设计

#### Collection 1: air_quality
```javascript
{
    _id: ObjectId,
    station: String,        // 监测站名称
    aqi: Number,           // 空气质量指数
    health_risk: String,   // 健康风险等级
    pollutants: {          // 各污染物浓度
        pm25: Number,
        pm10: Number,
        no2: Number,
        so2: Number,
        o3: Number
    },
    timestamp: ISODate,
    location: {            // 地理位置
        type: "Point",
        coordinates: [longitude, latitude]
    },
    raw_data: Object
}
```

#### Collection 2: traffic_flow
```javascript
{
    _id: ObjectId,
    location: String,
    traffic_density: String,  // 交通密度等级
    vehicle_count: Number,
    average_speed: Number,
    timestamp: ISODate,
    camera_id: String,
    raw_data: Object
}
```

#### Collection 3: weather_data
```javascript
{
    _id: ObjectId,
    location: String,
    temperature: Number,
    humidity: Number,
    rainfall: Number,
    wind_speed: Number,
    wind_direction: String,
    timestamp: ISODate,
    forecast: Object
}
```

#### Collection 4: analysis_results
```javascript
{
    _id: ObjectId,
    analysis_type: String,
    time_range: {
        start: ISODate,
        end: ISODate
    },
    results: {
        correlation: Number,
        patterns: Array,
        anomalies: Array,
        insights: String
    },
    timestamp: ISODate
}
```

### 第四步: 数据分析算法

#### 1. 移动平均算法
用于平滑时间序列数据，识别趋势。

```javascript
function movingAverage(data, windowSize) {
    var result = [];
    for (var i = windowSize - 1; i < data.length; i++) {
        var sum = 0;
        for (var j = 0; j < windowSize; j++) {
            sum += data[i - j];
        }
        result.push(sum / windowSize);
    }
    return result;
}
```

#### 2. 相关性分析
计算两个变量之间的皮尔逊相关系数。

```javascript
function calculateCorrelation(x, y) {
    var n = x.length;
    var sum_x = 0, sum_y = 0, sum_xy = 0;
    var sum_x2 = 0, sum_y2 = 0;

    for (var i = 0; i < n; i++) {
        sum_x += x[i];
        sum_y += y[i];
        sum_xy += x[i] * y[i];
        sum_x2 += x[i] * x[i];
        sum_y2 += y[i] * y[i];
    }

    var numerator = n * sum_xy - sum_x * sum_y;
    var denominator = Math.sqrt((n * sum_x2 - sum_x * sum_x) *
                                (n * sum_y2 - sum_y * sum_y));

    return numerator / denominator;
}
```

#### 3. 异常检测
使用Z-score方法检测异常值。

```javascript
function detectAnomalies(data, threshold = 3) {
    var mean = data.reduce((a, b) => a + b, 0) / data.length;
    var variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / data.length;
    var stdDev = Math.sqrt(variance);

    var anomalies = [];
    for (var i = 0; i < data.length; i++) {
        var zScore = Math.abs((data[i] - mean) / stdDev);
        if (zScore > threshold) {
            anomalies.push({
                index: i,
                value: data[i],
                zScore: zScore
            });
        }
    }

    return anomalies;
}
```

### 第五步: Dashboard 设计

#### Dashboard 页面布局

**页面1: 实时监控**
- 当前空气质量指数（Gauge）
- 各监测站AQI分布图（Bar Chart）
- 最近24小时AQI趋势（Line Chart）
- 交通流量热力图

**页面2: 历史分析**
- 可选时间范围的数据查询
- 多指标对比图表
- 周/月趋势分析

**页面3: 关联分析**
- 空气质量与交通流量关联散点图
- 天气与能源消耗关联图
- 相关性系数展示

**页面4: 预警系统**
- 当前预警信息
- 预警历史记录
- 预警规则配置

## 数据采集策略

### 采集频率建议
- 空气质量数据: 每15分钟
- 交通数据: 每10分钟
- 天气数据: 每30分钟
- 能源数据: 每小时

### 数据保留策略
- 原始数据: 保留3个月
- 小时聚合数据: 保留1年
- 日聚合数据: 永久保留

### 错误处理
- API调用失败: 重试3次，间隔递增
- 数据异常: 记录日志，跳过该次采集
- 数据库连接失败: 缓存数据，恢复后批量写入

## 性能优化

### Node-RED优化
1. 合理设置采集频率，避免过于频繁
2. 使用 `batch` 节点批量处理数据
3. 避免在 Function 节点中进行复杂计算
4. 使用 `delay` 节点控制流量

### MongoDB优化
1. 创建索引:
   ```javascript
   db.air_quality.createIndex({ "timestamp": -1 })
   db.air_quality.createIndex({ "station": 1, "timestamp": -1 })
   db.traffic_flow.createIndex({ "timestamp": -1 })
   db.traffic_flow.createIndex({ "location": 1, "timestamp": -1 })
   ```

2. 使用聚合管道进行复杂查询
3. 定期清理过期数据
4. 配置适当的内存限制

## 测试策略

### 单元测试
- 测试各个 Function 节点的数据处理逻辑
- 测试API调用的错误处理

### 集成测试
- 测试完整的数据流
- 测试数据库读写操作
- 测试Dashboard显示

### 数据验证
- 验证API返回数据的格式
- 验证数据范围的合理性
- 验证时间戳的准确性

## 常见问题解决

### 问题1: API调用失败
**原因**: 网络问题、API限流、URL错误
**解决**:
- 检查网络连接
- 查看API文档，确认URL和参数
- 实现重试机制
- 添加错误日志

### 问题2: MongoDB连接超时
**原因**: 数据库未启动、连接配置错误
**解决**:
- 检查Docker容器状态
- 验证连接字符串
- 检查网络配置

### 问题3: Dashboard不显示数据
**原因**: 数据格式错误、节点配置问题
**解决**:
- 使用Debug节点检查数据流
- 验证Dashboard节点配置
- 检查数据格式是否符合要求

## 项目扩展建议

### 短期扩展
1. 添加更多数据源（停车场占用率、公共设施使用率等）
2. 实现移动端响应式Dashboard
3. 添加数据导出功能（CSV, Excel）

### 长期扩展
1. 机器学习预测模型
   - 使用历史数据训练预测模型
   - 预测未来空气质量、交通状况

2. 实时告警系统
   - 邮件/短信通知
   - 微信推送

3. 多城市对比分析
   - 扩展到其他城市的开放数据
   - 横向对比分析

4. API服务
   - 提供RESTful API供第三方调用
   - 数据开放共享

## 参考资源

### 官方文档
- Node-RED: https://nodered.org/docs/
- MongoDB: https://www.mongodb.com/docs/
- Docker: https://docs.docker.com/

### data.gov.hk 常用API
- 环保署空气质量: https://data.gov.hk/tc-data/dataset/hk-epd-airteam-air-quality-health-index
- 运输署交通快拍: https://data.gov.hk/tc-data/dataset/hk-td-tis_2-traffic-snapshot-images
- 天文台天气数据: https://data.gov.hk/tc-data/dataset/hk-hko-rss-current-weather-report

### Node-RED Nodes
- node-red-dashboard: 仪表板UI
- node-red-node-mongodb: MongoDB集成
- node-red-contrib-aggregator: 数据聚合

## 总结

本解决方案提供了一个完整的智慧城市数据分析平台架构，涵盖：
- 多数据源采集
- 实时数据处理
- 历史数据存储
- 关联分析
- 可视化展示

通过合理的架构设计和实现，可以为城市管理提供有价值的数据洞察，支持智慧城市建设。
